
<html>
  <head>
    <title> New Test Library </title>
    <link rel="stylesheet" type="text/css" href="../static/css/custom.css">
    <link rel="stylesheet" type="text/css" href="../static/css/testLibrary.css">
    <link rel="stylesheet" type="text/css" href="../static/bootstrap/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script src="../static/js/addons/angular.min.js"></script>
  </head>
  <body id="mainBackground">
    <div class="container">
      <nav id="topNavBar" class="navbar navbar-inverse navbar-collapse collapse">
        <div class="container-fluid">
          <div class="navbar-header">
            <img class="logo" src="../static/images/Glogo.png" style="width:110px;">
          </div>
          <div id="navbar">
            <ul class="topmenu nav navbar-nav" style="margin-left:15%;">
              <li><a href="testresults">CANVAS</a></li>
              <li class="dots glyphicon glyphicon-option-vertical"></li>
              <li><a href="instruments">INSTRUMENTS</a></li>
              <li class="dots glyphicon glyphicon-option-vertical"></li>
              <li><a href="community">COMMUNITY</a></li>          
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a class="glyphicon glyphicon-envelope" href="../navbar-static-top/"></a></li>
              <li><a class="glyphicon glyphicon-bell" href="../navbar-static-top/"></a></li>
              <li><a class="glyphicon glyphicon-user" href="../navbar-fixed-top/">Profile</a></li>
            </ul>
          </div>
        </div>
      </nav>
    </div>
    <div  ng-app="" class="col-md-12" id="testListBox">
      <h2 class="instType">Test Library</h2>
       <h4 class="colTitle text-uppercase">Test Plan <span style="margin-right: 400px"></span> Preview<span style="margin-right: 300px"></span> Options</h4>
      <hr class="headerLine">
        <table id="testTable" style="color:white;" class=""></table>
    </div>

<script type="text/javascript">
  // load chart lib
  google.load('visualization', '1', {packages: ['corechart']})
  google.setOnLoadCallback(fetchTestLib);

    //LOADING URL
    test_lib_url = window.location.pathname + '.json';
    //console.log(test_lib_url);

  var index = 0;
  function fetchTestLib(){
      //var test_lib_url = 'https://gradientone-test.appspot.com/testlibrary/acme.json'; 
      //comment out for live version ^
        $.ajax({
          async: true,
          url: test_lib_url,            
          dataType: 'json',
       }).done(function (results) {
        var testArray = results;

        var testTable = "<table>";

        for (i=0;i<testArray.length;i++) {
            var starttse = Number(testArray[i].start_tse);
            var endtse = Number(testArray[i].test_complete)
            var sd = new Date(starttse);
            var ed = new Date(endtse)
            var formatStartDate = (sd.getMonth()+1) + "/" + sd.getDate() + "/" + sd.getFullYear() + " " + sd.getHours() + ":" + sd.getMinutes() + ":" + sd.getSeconds() + "." + sd.getMilliseconds();
            var formatEndDate = (ed.getMonth()+1) + "/" + ed.getDate() + "/" + ed.getFullYear() + " " + ed.getHours() + ":" + ed.getMinutes() + ":" + ed.getSeconds() + "." + ed.getMilliseconds();
            console.log('formated date = ',formatStartDate);
            index = i;

            testTable+= "<tr>" + "<span class='name'>" + "Name: "  + "</span>" + testArray[i].testplan_name + "</tr>";
            testTable+="<br>";
            testTable+="<span class='startTime'>" + "Start Time: " + "</span>" + "<tr>" + formatStartDate + "</tr>";
            testTable+="<br>";
            testTable+="<span class='endTime'>" + "End Time: " + "</span>" + "<tr>" + formatEndDate + "</tr>";
            testTable+="<br>";
            testTable+="<a href='https://gradientone-test.appspot.com/testlibrary/acme/" + testArray[i].testplan_name + "/" + testArray[i].start_tse + "'>results</a>";
            testTable+="<div class='decChart' id='decChart" + index + "'></div>";
            fetchDecData(testArray[i],index)
            console.log('fetchTestLib: test Lib = ', testArray[i].start_tse);
        };
        testTable+="</table>";
        console.log('testTable',testTable);
        document.getElementById("testTable").innerHTML = testTable;
        });
      };

    function fetchDecData(testArray,index){
       //console.log('fetchDecData: testArray = ',testArray);
       dec_urlPath = testArray.dec_data_url;
       //console.log('fetchDecData: dec_urlPath = ',dec_urlPath);
       $.ajax({
          async: true,
          url: dec_urlPath,            
          dataType: 'json',
       }).done(function (results) {
          //console.log("fetchDecData: json_url =", json_url);
         var decData = results.cha;
         var decPointSpacing = testArray.Raw_msec_btw_samples;
         var offset = 0;
         // var offset = (sampleSize/sampleRate)/2;

         //console.log('fetchDecData: decPointSpacing =',decPointSpacing);
         //console.log('decData :',decData);
         //console.log('Index = ', index);
       drawDecChart(decData, decPointSpacing, offset, index);
      });
    };

    // BUILD DEC DATA TABLE AND DRAW DEC CHART
    function drawDecChart(decData, decPointSpacing,offset,index) {
      console.log('drawDecChart: index',index);
      chartID = "#decChart" + index
      var data = new google.visualization.DataTable();
        data.addColumn('number', 'Time');
        data.addColumn('number', 'Ch1');

        for (i=0; i<decData.length; i++) {
           var num = i*decPointSpacing - offset;
           num = Math.ceil(num * 100) / 100;
           data.addRow([
             num, 
             decData[i],
             ]);
        };
        decChartOptions = {
         title: 'Preview',
         titleTextStyle: {color:'lightgray', fontSize: 18, fontName: 'NexaLight'},
         legend: 'none',
         hAxis: {title: 'Time(sec)',titleTextStyle:{color:'lightgray', fontName: 'NexaLight'}, textStyle:{color:'lightgray'}, baselineColor:'white', gridlines:{color: 'none', count: 5},viewWindowMode:'explicit'},
         vAxis: {title: '', titleTextStyle:{color:'lightgray'}, textStyle:{color:'lightgray'}, baselineColor:'white', gridlines:{color: 'none', count: 0}, format: '##.###', viewWindowMode:'explicit'},
         backgroundColor: {fill:'none', stroke: 'black', strokeWidth: 0,},
         colors: ['rgb(2,255,253)','rgb(239,253,146)'],
         lineWidth: 2,
         curveType: 'function',
        };
      //DRAW CHART
         var chart = new google.visualization.LineChart($(chartID).get(0));      
         chart.draw(data, decChartOptions);
    };

</script>

  </body>
</html>