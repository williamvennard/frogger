<html>
  <head>
    <title>Test Library</title>
    <link rel="stylesheet" type="text/css" href="../static/css/custom.css">
    <link rel="stylesheet" type="text/css" href="../static/css/testLibrary.css">
    <link rel="stylesheet" type="text/css" href="../static/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="../static/css/hoverzoom.css">
    <link rel="stylesheet" type="text/css" href="../static/css/fonts/stylesheet.css" charset="utf-8" />    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script src="../static/js/addons/angular.min.js"></script>

    <meta name="niewport" content="width=device-width">
  </head>
  <body id="mainBackground">
    <div class="container">
      <nav id="topNavBar" class="navbar navbar-inverse navbar-collapse collapse">
        <div class="container-fluid">
          <div class="navbar-header">
            <img class="logo" src="../static/images/Glogo.png" style="width:110px;">
          </div>
          <div id="navbar">
            <ul class="topmenu nav navbar-nav" style="margin-left:15%;">
              <li><a href="testresults">CANVAS</a></li>
              <li class="dots glyphicon glyphicon-option-vertical"></li>
              <li><a href="instruments">INSTRUMENTS</a></li>
              <li class="dots glyphicon glyphicon-option-vertical"></li>
              <li><a style="color:rgb(124,175,46);" href="testlibrary">TEST LIBRARY</a></li>
              <li class="dots glyphicon glyphicon-option-vertical"></li>
              <li><a href="community">COMMUNITY</a></li>           
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a class="glyphicon glyphicon-envelope" href="../navbar-static-top/"></a></li>
              <li><a class="glyphicon glyphicon-bell" href="../navbar-static-top/"></a></li>
              <li><a class="glyphicon glyphicon-user" href="../navbar-fixed-top/">Profile</a></li>
            </ul>
          </div>
        </div>
      </nav>
    </div>
    <div class="col-md-12">
      <h1 id="libTitle">Test Library</h1> 
    </div>
    <div class="col-md-12" id="testListBox">
       <h4 class="colTitle text-uppercase">Test Plan <span style="margin-right: 175px"></span> Preview<span style="margin-right: 20%"></span>Measurements</h4>
      <hr class="headerLine">
        <div id="testTable" style="color:white;" class=""></div>
    </div>
    <div class="col-md-12" id="testListBox">
       <h4 class="colTitle text-uppercase">Trace<span style="margin-right: 215px"></span> Preview<span style="margin-right: 20%"></span>Measurements</h4>
      <hr class="headerLine">
        <div id="traceTable" style="color:white;" class=""></div>
    </div>


<script type="text/javascript">
  // load chart lib
  google.load('visualization', '1', {packages: ['corechart']})
  google.setOnLoadCallback(fetchTestLib);
    //LOADING URL
    test_lib_url = window.location.pathname + '.json';
    //console.log(test_lib_url);
  var index = 0;
  function fetchTestLib(){
       //test_lib_url = 'https://gradientone-test.appspot.com/testlibrary/Acme.json'; 
      //comment out for live version ^
        $.ajax({
          async: true,
          url: test_lib_url,            
          dataType: 'json',
       }).done(function (results) {
        var testArray = results;
        var testTable = "<div>";
        var traceTable = "<div>";
        for (i=0;i<testArray.length;i++) {
            index = i;
            var starttse = Number(testArray[i].start_tse);
            var endtse = Number(testArray[i].test_complete)
            var sd = new Date(starttse);
            var ed = new Date(endtse)
            var formatStartDate = (sd.getMonth()+1) + "/" + sd.getDate() + "/" + sd.getFullYear() + " " + sd.getHours() + ":" + sd.getMinutes() + ":" + sd.getSeconds() + "." + sd.getMilliseconds();
            var formatEndDate = (ed.getMonth()+1) + "/" + ed.getDate() + "/" + ed.getFullYear() + " " + ed.getHours() + ":" + ed.getMinutes() + ":" + ed.getSeconds() + "." + ed.getMilliseconds();
            //TEST IF test_plan or trace
            if (testArray[i].test_plan  === 'True') {
                testTable+="<div style='margin-bottom: -60px;'>";
                testTable+="<span class='name'>" + "Name: "  + "</span>" + "<span  class='testName text-capitalize'>" + testArray[i].testplan_name + "</span>";
                testTable+="<br>";
                testTable+="<span class='startTime'>" + "Start Time: " + "</span>" + "<span class='libTime'>" + formatStartDate + "</span>";
                testTable+="<br>";
                testTable+="<span class='endTime'>" + "End Time: " + "</span>" + "<span class='libTime'>" + formatEndDate + "</span>";
                testTable+="<br>";
                testTable+="<a class='resultsLink' href='https://gradientone-test.appspot.com/testlibrary/" + testArray[i].company_nickname + "/" + testArray[i].testplan_name + "/" + testArray[i].start_tse + "'>Results</a>";
                testTable+="<div class='decChart hoverzoom showHidden' id='decChart" + index + "'></div>";
                testTable+="<div class='hiddenInfo' style='color:white;'>Stuff shown on hover</div>"
                testTable+="</div>"; 

                fetchDecData(testArray[i],index)
            }else if (testArray[i].trace === 'True') {
                traceTable+= "<div style='margin-bottom: -60px;'>"
                traceTable+= "<span class='name'>" + "Name: "  + "</span>" + "<span  class='testName text-capitalize'>" + testArray[i].testplan_name + "</span>";
                traceTable+="<br>";
                traceTable+="<span class='startTime'>" + "Start Time: " + "</span>" + "<span class='libTime'>" + formatStartDate + "</span>";
                traceTable+="<br>";
                traceTable+="<span class='endTime'>" + "End Time: " + "</span>" + "<span class='libTime'>" + formatEndDate + "</span>";
                traceTable+="<br>";
                traceTable+="<a class='resultsLink' href='https://gradientone-test.appspot.com/testlibrary/" + testArray[i].company_nickname + "/" + testArray[i].testplan_name + "/" + testArray[i].start_tse + "'>Results</a>";
                traceTable+="<div class='decChart hoverzoom showHidden' id='decChart" + index + "'></div>";
                traceTable+="<div class='hiddenInfo' style='color:white;'>Stuff shown on hover</div>"
                traceTable+="</div>"; 

                fetchDecData(testArray[i],index)
            };
        };
        testTable+="</div>";
        traceTable+="</div>";
        //console.log('testTable',testTable);
        document.getElementById("testTable").innerHTML = testTable;
        document.getElementById("traceTable").innerHTML = traceTable;
        });
    };

    function fetchDecData(testArray,index){
       //console.log('fetchDecData: testArray = ',testArray);
       dec_urlPath = testArray.dec_data_url;
       //console.log('fetchDecData: dec_urlPath = ',dec_urlPath);
       $.ajax({
          async: true,
          url: dec_urlPath,            
          dataType: 'json',
       }).done(function (results) {
          //console.log("fetchDecData: json_url =", json_url);
         var decData = results.cha;
         var decPointSpacing = testArray.Raw_msec_btw_samples;
         var offset = 0;
         // var offset = (sampleSize/sampleRate)/2;

         //console.log('fetchDecData: decPointSpacing =',decPointSpacing);
         console.log('decData :',decData);
         //console.log('Index = ', index);
       drawDecChart(decData, decPointSpacing, offset, index);
      });
    };

    // BUILD DEC DATA TABLE AND DRAW DEC CHART
    function drawDecChart(decData, decPointSpacing,offset,index) {
      //console.log('drawDecChart: index',index);
      chartID = "#decChart" + index;
      var data = new google.visualization.DataTable();
        data.addColumn('number', 'Time');
        data.addColumn('number', 'Ch1');

        for (i=0; i < decData.length; i++) {
           var num = i*decPointSpacing - offset;
           num = Math.ceil(num * 100) / 100;
           data.addRow([
             num, 
             decData[i],
             ]);
        };
        decChartOptions = {
         title: 'Preview',
         titleTextStyle: {color:'lightgray', fontSize: 18, fontName: 'NexaLight'},
         legend: 'none',
         hAxis: {title: '',titleTextStyle:{color:'lightgray', fontName: ''}, textStyle:{color:'lightgray'}, baselineColor:'white', gridlines:{color: 'none', count: 5},viewWindowMode:'explicit'},
         vAxis: {title: '', titleTextStyle:{color:'lightgray'}, textStyle:{color:'lightgray'}, baselineColor:'white', gridlines:{color: 'none', count: 0}, format: '##.###', viewWindowMode:'explicit'},
         backgroundColor: {fill:'none', stroke: 'black', strokeWidth: 0,},
         colors: ['rgb(2,255,253)','rgb(239,253,146)'],
         lineWidth: 2,
         curveType: 'function',
         crosshair: 'none',
         enableInteractivity: false,
        };

        console.log('drawDecChart: data = ',data);
      //DRAW CHART
         var chart = new google.visualization.LineChart($(chartID).get(0)); 
         chart.draw(data, decChartOptions);    
    };

</script>

  </body>
</html>