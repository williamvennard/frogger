<!DOCTYPE html>
<!--{% block import %}-->
<html>
<head>
  <title>Library Results</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  <script type="text/javascript" src="js/addons/jquery.knob.min.js"></script>
  <link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="css/custom.css">
  <link rel="stylesheet" type="text/css" href="css/testResultsPage.css">



</head>
<body id="mainBackground">
  <div class="container">
    <div class="row">
      <nav id="topNavBar" class="navbar navbar-inverse navbar-collapse collapse"> <!--NAVBAR-->
        <div class="container-fluid">
          <div class="navbar-header">
            <img class="logo" src="images/Glogo.png" style="width:110px;" alt="Gradient One logo">
          </div>
          <div id="navbar">
            <ul class="topmenu nav navbar-nav">
              <li><a class="currentPage" href="index.html" style="color: rgb(124,175,46);">CANVAS</a></li>
              <li class="dots glyphicon glyphicon-option-vertical"></li>
              <li><a href="instruments.html">INSTRUMENTS</a></li>
              <li class="dots glyphicon glyphicon-option-vertical"></li>
              <li><a href="community.html">COMMUNITY</a></li>          
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a class="glyphicon glyphicon-envelope" href="../navbar-static-top/"></a></li>
              <li><a class="glyphicon glyphicon-bell" href="../navbar-static-top/"></a></li>
              <li><a class="glyphicon glyphicon-user" href="../navbar-fixed-top/">Profile</a></li>
            </ul>
          </div>
        </div>
      </nav>
    </div>
    <div> <!--HEADER-->
        <div class="" style="min-width: 100px;" id="compHeader">
         <h1 class="compName" id="testPlanCompany">Test Results</h1> 
        </div>
      </div>
    <div class="container">
      <div class="row testResultsBox"><!--TEST RESULTS BOX -->
          <div class="col-md-4" id="testPlanInfoBox">
            <h1 class="testPlanInfo" id="testPlanName"></h1>  
              <h3 class="testPlanInfo" id="testPlanAuthor"></h3>
              <p class="testPlanInfo" id="testPlanDate"></p>
              <div id="measurementsBox">
                <p>-horizontal-</p>
                <div class="knobs">
                        <section>
                          <div id="knob1">
                            <p id="knob1Label">Position</p>
                            <input 
                            type="text" 
                            value="0"
                            data-step="1"
                            data-min="-10"
                            data-max="10" 
                            class="hPosKnob"
                            data-cursor= "10"
                            data-width="50"
                            data-fgColor="rgb(2,255,253)"
                            data-thickness=".5"
                            data-bgColor="white"
                            data-angleOffset="-125"
                            data-angleArc="250">

                          </div>
                        </section>
                        <section id="horiz">
                          <div id="knob2">
                            <p id="knob2Label">Zoom</p>
                            <input 
                            type="text" 
                            value="0"
                            data-min="10"
                            data-max="1000" 
                            class="hZoomKnob"
                            data-cursor= "10"
                            data-width="50"
                            data-fgColor="rgb(2,255,253)"
                            data-thickness=".5"
                            data-angleOffset="-125"
                            data-angleArc="250"
                            data-bgColor="white">
                          </div>
                        </section>
                      </div>
                <div  id="testMeasRes"></div>
              </div>
          </div>
          <br><br><br>
          <div class="row-md-7" id="dataDisplayBox">
            <div class="row-md-6;" id="resultsChartCSS">
              <div id="rawChart" style="height: 450px; width: 650px;"></div>
            </div>
            <div class="row-md-3"  id="resultsTableCSS">
              <div id="rawTable" ></div>
            </div>
          </div>
          <div class="row" >
            <div class="col-md-12">
              <div id="decChart" style="height: 200px; width: 300px;"></div>
              <div id="decTable"></div>
              
            </div>
          </div>
          
      </div>
    </div>

 <script type="text/javascript">

    //VERTICAL KNOBS
    var vZoom = 100;
    var vPosition = 0;
    $(".vPosKnob").knob({
        'release' : function (vPos) { 
          //console.log('knob H pos value:',hPos);  
          vPosition = vPos;
          doPoll();
      },
    }); 

    $(".vZoomKnob").knob({
      'release' : function (vRange) { 
         //console.log('knob H value:',hRange);
         vZoom = vRange;
         doPoll();
      },
    }); 
//HORIZONTAL KNOBS
    var hZoom = 100;
    var hPosition = 0;
    $(".hPosKnob").knob({
        'release' : function (hPos) { 
          //console.log('knob H pos value:',hPos);  
          hPosition = hPos;
          doPoll();
      },
    }); 

    $(".hZoomKnob").knob({
      'release' : function (hRange) { 
         //console.log('knob H value:',hRange);
         hZoom = hRange;
         doPoll();
      },
    }); 

 // load chart lib
    google.load('visualization', '1', {packages: ['corechart','table']});
       var doPollCounter = 0;
       var sliceNames = [];
       var resultsCache = [];
       var autoMaxPosition = 0;
       var autoMinPosition = 0;
       var hMax = 0;
       var hMin = 0;
       var chartOptions = {};
       var data = [];
       var rawTime = [];
       var sliceBuild = 0;
       var endSlice = 0;
       var numPages = 0;
       var deltaFromStart = 0;
       var sampleSize = 0;
       var range = 0;
      //LOADING URL
          var urlPath = window.location.pathname.split( '/' );
          var newPathname = urlPath[urlPath.length - 1];
          console.log(urlPath);
          console.log(newPathname);

       //DECIMATED DATA PLOT
       function fetchDecData(){
          dec_base_url = 'https://gradientone-test.appspot.com/dec/bscopedata/arduino/';
          dec_urlPath = '1435775476910';
          //dec_urlPath = newPathname;
          dec_json_url = dec_base_url + dec_urlPath;
          $.ajax({
             async: true,
             url: dec_json_url,            
             dataType: 'json',
          }).done(function (results) {
             //console.log("fetchDecData: json_url =", json_url);
            var decData = results.cha;
             //console.log("results:", decData);
            //console.log('decData Test:',decData);
            var config = results.config;
            var cleanConfig = config.substr(1, config.length-2);
            var configArray = cleanConfig.split(', ');

            var sampleSize = configArray[7].split(': ')[1];
            var sampleRate = configArray[configArray.length-1].split(': ')[1];
            console.log('Config:',configArray);
            

            var decPointSpacing = (1/Number(sampleRate))*10;
            var offSet = (sampleSize/sampleRate)/2;

            console.log('dec point spacing should be .01:',decPointSpacing);
            console.log('off set = ',offSet);
                           //var configOptions = rawData[0].config;
               //console.log('config options: ',configOptions);
              // var formatConfig = configOptions.substr(1, configOptions.length-2);
              // var configArray = formatConfig.split(', ');
                           //sampleSize = Number(configArray[7].split(': ')[1]);
              // var sampleRate = configArray[configArray.length-1].split(': ')[1];

          data = new google.visualization.DataTable();
            data.addColumn('number', 'Time');
            data.addColumn('number', 'Ch1');

            //GETING DATA
            for (i=0; i<decData.length; i++) {
              data.addRow([
                (i*decPointSpacing - offSet), 
                decData[i],
                ]);
            };
            //console.log('Data:',data);  
          //var dataTest = data;
              //console.log('DataTest:',dataTest);
          var options = {
            title: 'Decimated Data',
          };
         //DRAW CHART
            var chart = new google.visualization.LineChart($('#decChart').get(0));      
            chart.draw(data, options);
         //DRAW TABLE
            var table = new google.visualization.Table($('#decTable').get(0));
            table.draw(data); 
          });
       };

       //google.load("visualization", "1", {packages:["corechart"]});
       google.setOnLoadCallback(fetchDecData);

//RAW DATA PLOT
       function fetchData(base_url,sliceName,use_async){
          json_url = base_url + sliceName;
          $.ajax({
             async: use_async,
             url: json_url,            
             dataType: 'json',
          }).done(function (results) {
             //console.log("fetchData: json_url =", json_url);
             //console.log("fetchData: sliceName =", sliceName);
             //console.log("fetchData: results =", results);
             resultsCache[sliceName] = results;
             //console.log("61:resultsCache[sliceName] =", resultsCache[sliceName]);
          })  // need error handler
       };

       function doPoll(){
          doPollCounter++;
          var data = new google.visualization.DataTable();
          data.addColumn('number', 'Time');
          data.addColumn('number', 'Ch1');

          //var startTime = Date.now();
     
          function gatherData(base_url,sliceNames,first,last){
            var sliceName = sliceNames[first];
            if (!(sliceName in resultsCache)) {
                 json_url = base_url + sliceName;
                 //console.log("gatherData: cache miss: json_url =", json_url);
                 fetchData(base_url,sliceName,false);
               };
            var gatheredResults = resultsCache[sliceName];
            var firstRow = gatheredResults['data'][0];
            //console.log('gatherData: First row: ',firstRow);
            /*
            if (autoMinPosition == 0) {
              //console.log('auto min and max:',firstRow.TIME)
              
              autoMinPosition = Number(firstRow.TIME);
              autoMaxPosition = Number(firstRow.TIME)+range;
              hMax = autoMaxPosition;
              hMin = autoMinPosition;
              //console.log("chart options viewWindow:", chartOptions.hAxis.viewWindow);
              chartOptions.hAxis.viewWindow.max = hMax;
              chartOptions.hAxis.viewWindow.min = hMin;
            };
            */
            for (idx = first; idx < last; idx++) {
               sliceName = sliceNames[idx];
               //console.log("gatherData: sliceName =", sliceName);
               //console.log("gatherData: idx =", idx);
               if (!(sliceName in resultsCache)) {
                 json_url = base_url + sliceName;
                 //console.log("gatherData: cache miss: json_url =", json_url);
                 fetchData(base_url,sliceName,false);
               };
               gatheredResults = resultsCache[sliceName];
               //console.log("gatherData: resultsCache =", resultsCache);
               //console.log("gatherData: idx = ", idx);

               //Y AXIS VOLTAGE DATA "CHA"
               var rawData = gatheredResults['data'];
               var rawCha = rawData[0].cha;
               //console.log('cha data array: ',rawCha);

               var configOptions = rawData[0].config;
               //console.log('config options: ',configOptions);
               var formatConfig = configOptions.substr(1, configOptions.length-2);
               var configArray = formatConfig.split(', ');

               sampleSize = Number(configArray[7].split(': ')[1]);
               var sampleRate = configArray[configArray.length-1].split(': ')[1];
               var timeSlice = (1/(parseFloat(sampleRate)));

               endSlice = Number(rawData[0].start_tse)+ Number(sampleSize) -10;
               numPages = (Number(sampleSize)/10);
               
 

              //console.log('rawTime: ', rawTime);
              //console.log('config', configArray);
              //console.log('Sample Size: ', sampleSize);
              //console.log('Sample Rate: ', sampleRate);

               //console.log("gatherData: gatheredResults =", gatheredResults['data']);
               //GETING DATA
               //X AXIS TIME
               start = sliceBuild;
               //console.log('Start time:',start);
               deltaFromStart = Number(sliceName) - start;
               //console.log('slicename: ', sliceName);
               adjust = start + (Number(sampleSize)/2);
               deltaFromStart = Number(sliceName) - adjust;
               //console.log('deltaFrom start=',deltaFromStart);

               //d = Date(sliceName)-Date(sliceBuild)-width/2;
               
               //BUILD DATA TABLE ADDING ROWS TIME AND CHA
              for (i=0; i<rawCha.length; i++) {
                data.addRow([
                  (deltaFromStart + i)/1000, 
                  parseFloat(rawCha[i]),
                  ]);
              };
            

            };
          
            //var endTime = Date.now();
            //console.log('Timer:', endTime - startTime);

            //DRAW CHART
            var chart = new google.visualization.LineChart($('#rawChart').get(0));      
            chart.draw(data, chartOptions);
            //DRAW TABLE
            var table = new google.visualization.Table($('#rawTable').get(0));
            table.draw(data, tableOptions);  
          };

            //console.log('auto MAX position:',autoMaxPosition);
            //console.log('auto MIN position:',autoMinPosition);
            //var center = hPosition + (autoMinPosition + autoMaxPosition)/2;
            var center = hPosition;
            //console.log('Center = ',center)
            //var width = (autoMaxPosition - autoMinPosition)*(100.0/hZoom);
            var width = (sampleSize/1000)*(100.0/hZoom);
            //console.log('Width = ',width);

            //console.log('window width:', width);
            //console.log('window center:',center);

            //console.log('do poll counter:',doPollCounter);
            //old way 
            //hMax = center + width/2 + range;
            //hMin = center - width/2;

            //console.log('hMax:',hMax);
            //console.log('hMin:',hMin);
            //console.log('horizontal Zoom dial:',hZoom);
            //console.log('horizontal position dial:',hPosition);
            
        chartOptions = {
            title: 'Raw Data',
            titleTextStyle: {color:'lightgray', fontSize: 18, fontName: 'NexaLight'},
            legend: {alignment:'center', textStyle:{color:'lightgray'}},
            hAxis: {title: 'Time(sec)',titleTextStyle:{color:'lightgray', fontName: 'NexaLight'}, textStyle:{color:'lightgray'}, baselineColor:'white', gridlines:{color: 'gray', count: 6}, minorGridlines:{color: 'gray', count: 1}, viewWindowMode:'explicit', viewWindow:{max: hMax, min:hMin}},
            vAxis: {title: '', titleTextStyle:{color:'lightgray'}, textStyle:{color:'lightgray'}, baselineColor:'white', gridlines:{color: 'gray', count: 6}, minorGridlines:{color: 'gray', count: 1}, format: '##.###', viewWindowMode:'explicit', viewWindow:{max:2.5, min:-2.5} },
            backgroundColor: {fill:'none', stroke: 'black', strokeWidth: 0,},                 
            colors: ['rgb(2,255,253)','rgb(239,253,146)'],
            //chartArea:{backgroundColor:'', height:300, width:445},
            lineWidth: 2,
            curveType: 'function',
            crosshair: {trigger: 'both', selected:{opacity: 0.8}, focused:{opacity:0.8}},
          };
          var tableOptions = {
            showRowNumber: true,
          };

          //console.log("calling gatherData with name = ",sliceNames);
          //console.log("calling gatherData with length = ",sliceNames.length);

          //Drawing data test:
          gatherData(base_url,sliceNames,0,doPollCounter);

          //gatherData(base_url,sliceNames,0,sliceNames.length);

          //var pagingTest = (doPollCounter+1)*10;
          //console.log('do poll paging test:', pagingTest);
          
          sliceBuild = Number('1435775476910');
          //sliceBuild = Number(newPathname);

          //sliceStop = sliceBuild + 10*10;
          sliceStop = endSlice;
          //console.log('End Slice : ',endSlice);
          

          for (msec = sliceBuild+10; msec <= sliceStop;msec += 10) {
            name = String(msec);
            if ($.inArray(name, sliceNames) == -1) {
              sliceNames.push(String(msec));
            };
          };
          //console.log(sliceNames);
          //console.log('sample size?', numPages);
          //DYNAMIC RANGE AS PLOT GROWS
          if (doPollCounter < numPages-1) {
            hMax = range/2;
            hMin = (- width/2);
            range = (Number(sliceNames[doPollCounter]) - Number(sliceNames[0]))/1000;
            //console.log('Range in Number:',range);
          }else{
            range = 0;
            hMax = center + width/2;
            hMin = center - width/2;        
          };
          //console.log('range for auto max:',range);
          //console.log('sliceNames for range:',sliceNames);

          //gatherData used to go here

          //console.log('slice names:',sliceNames);
          //console.log("after gatherData length = ",sliceNames.length);
          
          for (idx in sliceNames) {
            if (!(sliceNames[idx] in resultsCache)) {
              fetchData(base_url,sliceNames[idx],true);
            };
          };
          //EVERY 100MS CALL doPoll
          if(doPollCounter < numPages) {
            setTimeout(doPoll,100);
          };
     
       };

// POLL FOR CURRENT TIME TO START PLOTTING DATA

     // var formatTime = (Math.round(Date.now()/100))*100;
     // console.log('current timestamp:',formatTime);
// BUILD SLICES GIVEN current Time

      //console.log('this runs first!');
      sliceNames.push('1435775476910');
      //sliceNames.push(newPathname);
      //sliceNames.push(String(Number('1435759475910')+10));

       var base_url = 'https://gradientone-test.appspot.com/bscopedata/arduino/';
       fetchData(base_url,sliceNames[0],true);
       //fetchData(base_url,sliceNames[1],true);

      //var range = (Number(sliceNames[sliceNames.length-1]) - Number(sliceNames[0]))/1000;
      //console.log('Range in Number:',range);
      //console.log('sliceNames for range:',sliceNames);


       google.setOnLoadCallback(doPoll);

</script>

</body>
</html>
<!--{% endblock %}-->
